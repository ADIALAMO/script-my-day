"use strict";(()=>{var a={};a.id=558,a.ids=[558],a.modules={5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},8052:(a,b,c)=>{c.r(b),c.d(b,{config:()=>r,default:()=>q,handler:()=>t});var d={};c.r(d),c.d(d,{default:()=>n});var e=c(9046),f=c(8667),g=c(3480),h=c(6435);let i=`
You are "ScriptCraft" — a senior screenwriter, comic/script expert and narrative philosopher.
Your job: transform a user's diary-style text into a professional, panel-by-panel script
(or screenplay-style scenes) in the SAME LANGUAGE as the user's input (Hebrew or English).

CORE RULES (must be strictly enforced):
1) PRESERVE ALL EVENTS: The output MUST include every event and character described in the user's text, in the same chronological order.
2) NO FACTUAL ALTERATIONS: You MUST NOT invent significant new events.
3) NAMES: Keep user-provided names.
4) GENRE ADAPTATION: Adapt tone to the requested genre.
5) LANGUAGE: Output must be in the user's input language.
6) FORMAT: Provide a panel/scene structured script.
7) LENGTH: Aim for 6-10 panels/scenes.
8) DRAMATIC ENRICHMENT: Add atmosphere and camera notes.
9) NO UNWANTED ADDITIONS: Keep it grounded.
10) OUTPUT ONLY: Return only the script text.
`,j=process.env.OPENROUTER_API_URL??"https://openrouter.ai/api/v1/chat/completions",k=process.env.OPENROUTER_API_KEY??"";async function l(a,b){if(!k)return{success:!1,error:"Missing OpenRouter API Key."};try{let{messages:c,lang:d}=function(a,b){let c=function(a){let b=/[\u0590-\u05FF]/.test(a),c=/[A-Za-z]/.test(a);return b&&!c?"he":c&&!b?"en":b?"he":"en"}(a),d=function(a,b){let c={drama:{he:"דרמה",en:"Drama"},action:{he:"פעולה",en:"Action"},comedy:{he:"קומדיה",en:"Comedy"},horror:{he:"אימה",en:"Horror"},romance:{he:"רומנטיקה",en:"Romance"},thriller:{he:"מותחן",en:"Thriller"},comic:{he:"קומיקס",en:"Comic"},"sci-fi":{he:"מדע בדיוני",en:"Sci-Fi"}},d=c[a]||c.drama;return"he"===b?d.he:d.en}(b,c);return{messages:[{role:"system",content:i},{role:"user",content:"he"===c?`להלן טקסט יומן של משתמש. אנא המר/י אותו לתסריט ${d} מקצועי, מחולק לסצנות/פאנלים. שמור/י על כל האירועים.`:`Here is a user's diary text. Convert it into a professional ${d} script.`},{role:"user",content:a}],lang:c}}(a,b),e="he"===d?`

### פקודות בימוי סופיות (חובה):
1. **כותרת תסריט**: בראש התסריט, תן שם יצירתי לסרט.
2. **דמויות**: שם פרטי ותיאור פיזי קצר בסוגריים.
3. **מגדר**: הקפד על לשון זכר או נקבה עקבית, ללא לוכסנים.
4. **סיום**: סיים תמיד במילים "סוף!".
5. **image (קריטי)**: בשורה האחרונה ממש, כתוב בדיוק כך: [image: Official movie poster, cinematic composition, hyper-realistic, dramatic color grading, professional studio lighting, 8k resolution, {English description of the scene without character names}].`:`

### FINAL PRODUCTION RULES:
1. Title: Create a catchy movie title.
2. Characters: First names and physical traits only.
3. End with "THE END!".
4. image: [image: Official movie poster, cinematic composition, hyper-realistic, dramatic color grading, professional studio lighting, 8k resolution, {Short visual description without names}].`;c.push({role:"user",content:e});let f=await fetch(j,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`,"X-Title":"LifeScript Studio"},body:JSON.stringify({model:"google/gemma-3-27b-it:free",messages:c,temperature:.8,max_tokens:1500,include_reasoning:!1})});if(!f.ok)throw await f.text(),Error(`OpenRouter error: ${f.status}`);let g=await f.json(),h=g?.choices?.[0]?.message?.content||"";return{success:!0,output:h}}catch(a){return console.error("Generation Error:",a),{success:!1,error:a.message}}}let m=new(require("ioredis"))(process.env.REDIS_URL,{connectTimeout:5e3,maxRetriesPerRequest:1});async function n(a,b){if("POST"!==a.method)return b.status(405).json({message:"Method Not Allowed"});try{let{journalEntry:c,genre:d,adminKeyBody:e,deviceId:f}=a.body,g=(a.headers["x-admin-key"]||a.headers["X-Admin-Key"]||e||"").toString().trim(),h=(process.env.ADMIN_SECRET||"").toString().trim();if(""===h||g!==h){let c=a.headers["x-device-id"]||f||(a.headers["x-forwarded-for"]||"").split(",")[0].trim()||a.socket.remoteAddress,d=new Date().toISOString().split("T")[0],e=`usage:${c}:${d}`;try{let a=await m.get(e);if((a?parseInt(a):0)>=2)return b.status(429).json({message:"\uD83C\uDFAC המסך ירד להיום. האורות באולפן כבו והמכסה היומית הסתיימה. נתראה בפרימיירה של מחר."});let d=await m.incr(e);1===d&&await m.expire(e,86400),console.log(`Usage tracked for Device/ID: ${c} | Count: ${d}`)}catch(a){console.error("Redis unreachable, relying on good faith:",a.message)}}if(!c)return b.status(400).json({message:"Missing journal entry"});let i=await l(c,d||"drama");if(!i.success)return b.status(500).json({message:i.error||"Failed to generate script"});return b.status(200).json({script:i.output})}catch(a){return console.error("API Error:",a),b.status(500).json({message:"תקלה בייצור התסריט."})}}var o=c(8112),p=c(8766);let q=(0,h.M)(d,"default"),r=(0,h.M)(d,"config"),s=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/generate-script",pathname:"/api/generate-script",bundlePath:"",filename:""},userland:d,distDir:".next",relativeProjectDir:""});async function t(a,b,c){let d=await s.prepare(a,b,{srcPage:"/api/generate-script"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,o.getTracer)(),e=d.getActiveScopeSpan(),j=s.instrumentationOnRequestError.bind(s),k=async e=>s.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:s.isDev,page:"/api/generate-script",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>j(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await k(e):await d.withPropagatedContext(a.headers,()=>d.trace(p.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:o.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},k))}catch(a){if(s.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}}};var b=require("../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[169],()=>b(b.s=8052));module.exports=c})();