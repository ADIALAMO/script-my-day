<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="app_title">   - 转住专  砖</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #7B68EE; /* 住  */
            --secondary-color: #FFD700; /*  */
            --accent-color: #3CB371; /* 专拽  */
            --danger-color: #DC3545; /*  */
            --text-color: #333;
            --light-text-color: #666;
            --bg-color: #f8f8ff; /*  专 专驻 */
            --card-bg: #ffffff;
            --border-color: #e0e6ec;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
            --border-radius: 12px;
        }

        body {
            margin: 0;
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 40px 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--card-bg);
            padding: 30px 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            max-width: 700px;
            width: 100%;
            text-align: center;
            position: relative;
        }

        h1 {
            font-size: 2.8rem;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }

        label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--light-text-color);
            text-align: right;
            font-size: 1.15rem;
        }

        textarea, select {
            width: calc(100% - 24px);
            padding: 14px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #fafbfd;
            direction: rtl;
        }

        textarea:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(123, 104, 238, 0.2); /* 爪 拽爪转 砖 爪注 砖 */
            outline: none;
        }

        /* 住转 注专 -textarea 砖 驻 */
        #resultContainer textarea {
            min-height: 200px; /*   转爪  */
            margin-bottom: 5px; /* 专 拽 转专 驻   */
        }


        .button-group {
            display: flex;
            flex-wrap: wrap; /* 驻砖专 驻转专 注专 砖专 住 拽 */
            gap: 15px; /* 专  驻转专 */
            justify-content: center;
            margin-top: 25px; /* 专 注 拽爪转 驻转专 */
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 28px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-sizing: border-box;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            flex-grow: 1; /* 驻砖专 驻转专   专  */
            min-width: 200px; /* 专  驻转专 */
        }
        button:hover {
            background-color: #6A5ACD; /*   转专 砖 住 */
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }

        /* 驻转专 砖专 - 爪注 砖 */
        .save-button {
            background-color: var(--accent-color); /* 专拽 */
        }
        .save-button:hover {
            background-color: #2E8B57; /* 专拽  转专 */
        }

        #resultContainer {
            margin-top: 40px;
            padding: 30px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            text-align: right;
        }

        #resultContainer h2, #savedFilesContainer h2 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 2rem;
            font-weight: 600;
        }

        #savedFilesContainer h3 {
            text-align: right;
            color: var(--light-text-color);
            margin-bottom: 15px;
            font-size: 1.4rem;
        }


        #loadingMessage, #errorMessage, #successMessage {
            text-align: center;
            font-weight: bold;
            margin-top: 25px;
            font-size: 1.15rem;
            padding: 12px;
            border-radius: 8px;
        }
        #loadingMessage {
            color: var(--primary-color);
            background-color: #edeafc; /* 专拽注 专 住 */
        }
        #errorMessage {
            color: var(--danger-color);
            background-color: #fdebeb;
        }
        #successMessage {
            color: var(--accent-color);
            background-color: #e6faed;
        }

        pre {
            background: #f8fbfd;
            padding: 25px;
            white-space: pre-wrap;
            word-wrap: break-word;
            border-radius: 10px;
            border: 1px solid #dbe2e9;
            font-size: 1.05rem;
            line-height: 1.8;
            color: #4a5a6a;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            direction: rtl;
        }

        /* --- 住转 住驻爪驻 砖驻转 --- */
        html[lang="en"] body {
            direction: ltr;
            text-align: left;
        }

        html[lang="en"] label {
            text-align: left;
        }

        html[lang="en"] textarea, html[lang="en"] select, html[lang="en"] pre {
            direction: ltr;
        }

        html[lang="en"] #resultContainer, html[lang="en"] #savedFilesContainer {
            text-align: left;
        }
        html[lang="en"] #savedFilesContainer h3 {
            text-align: left;
        }


        .language-selector {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            color: var(--light-text-color);
        }
        .language-selector select {
            width: auto;
            margin-bottom: 0;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1rem;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        html[lang="he"] .language-selector {
            left: auto;
            right: 20px;
            flex-direction: row-reverse;
        }
        html[lang="he"] .language-selector label {
            text-align: left;
        }

        /* 住转 专砖转 拽爪 砖专 */
        #savedDiariesList ul, #savedScriptsList ul {
            list-style-type: none;
            padding: 0;
        }

        #savedDiariesList li, #savedScriptsList li {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }

        #savedDiariesList li:hover, #savedScriptsList li:hover {
            background-color: #e9e9e9;
        }

        #savedDiariesList li button, #savedScriptsList li button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
            flex-shrink: 0; /* 注 驻转专 转抓 */
        }

        #savedDiariesList li button:hover, #savedScriptsList li button:hover {
            background-color: #6A5ACD;
        }

        #savedContentDisplay pre {
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        span[data-i18n="word_count"] {
            text-align: right;
        }
        html[lang="en"] span[data-i18n="word_count"] {
            text-align: left;
        }


        @media (max-width: 600px) {
            .container {
                padding: 20px 25px;
            }
            h1 {
                font-size: 2rem;
                margin-bottom: 20px;
            }
            button {
                font-size: 1.1rem;
                padding: 12px 20px;
                min-width: unset; /*  转  专 住 拽 */
            }
            label {
                font-size: 1rem;
            }
            textarea, select {
                font-size: 0.95rem;
                padding: 10px;
            }
            .language-selector {
                position: static;
                margin-bottom: 20px;
                justify-content: center;
                flex-direction: row;
            }
            html[lang="he"] .language-selector {
                right: auto;
                flex-direction: row;
            }
            .button-group {
                flex-direction: column; /* 驻转专  转转 砖 住 拽 */
            }
            #resultContainer textarea {
                min-height: 150px;
            }
            span[data-i18n="word_count"] {
                margin-bottom: 15px; /* 转拽 专   */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-selector">
            <label for="languageSelect" data-i18n="language_selector_label">砖驻:</label>
            <select id="languageSelect">
                <option value="he">注专转</option>
                <option value="en">English</option>
            </select>
        </div>

        <h1 data-i18n="main_title">锔   砖 专 拽拽住</h1>

        <div class="input-section">
            <label for="diaryEntry" data-i18n="diary_label"> 拽专 ? 专砖  转 砖转/转:</label>
            <textarea id="diaryEntry" rows="6" data-i18n-placeholder="diary_placeholder"></textarea>
            <span id="diaryWordCount" style="display: block; text-align: right; font-size: 0.9em; color: var(--light-text-color); margin-top: -20px; margin-bottom: 20px;" data-i18n="word_count">0 </span>


            <label for="genre" data-i18n="genre_label">专 '专 转住专</label>
            <select id="genre">
                <option value="">-- 专 '专 --</option>
                <option value="comedy" data-i18n="genre_comedy">拽</option>
                <option value="drama" data-i18n="genre_drama">专</option>
                <option value="fantasy" data-i18n="genre_fantasy">驻</option>
                <option value="sci-fi" data-i18n="genre_scifi">注 </option>
                <option value="adventure" data-i18n="genre_adventure">专驻转拽转</option>
                <option value="action" data-i18n="genre_action">驻注</option>
                <option value="slice of life" data-i18n="genre_slice_of_life">驻专住转  (驻专)</option>
            </select>

            <div class="button-group">
                <button id="generateButton" data-i18n="generate_script_button">驻 住驻专 拽拽住!</button>
                <button id="saveDiaryButton" class="save-button" data-i18n="save_diary_button" disabled>砖专 </button>
                <button id="showSavedButton" class="save-button" data-i18n="show_saved_button">爪 砖专</button>
            </div>
        </div>

        <div id="loadingMessage" class="status-message" style="display: none;"></div>
        <div id="errorMessage" class="status-message error-message" style="display: none;"></div>
        <div id="successMessage" class="status-message" style="display: none;"></div>


        <div id="resultContainer" style="display: none;">
            <h2 data-i18n="script_output_title">转住专 砖  砖:</h2>
            <textarea id="scriptOutput" rows="15" data-i18n-placeholder="script_placeholder"></textarea> 
            <span id="scriptWordCount" style="display: block; text-align: right; font-size: 0.9em; color: var(--light-text-color); margin-top: -20px; margin-bottom: 20px;" data-i18n="word_count">0 </span>
            <div class="button-group">
                <button id="saveScriptButton" class="save-button" data-i18n="save_script_button" disabled>砖专 转住专</button>
            </div>
        </div>

        <div id="savedFilesContainer" style="display: none; text-align: right; margin-top: 40px;">
            <h2 data-i18n="saved_files_title"> 转住专 砖专:</h2>
            <button id="closeSavedFiles" class="save-button" style="margin-bottom: 20px;" data-i18n="close_button">住专</button>
            <div id="savedDiariesList">
                <h3 data-i18n="saved_diaries_list_title">:</h3>
                <ul id="diariesList"></ul>
            </div>
            <div id="savedScriptsList" style="margin-top: 20px;">
                <h3 data-i18n="saved_scripts_list_title">转住专:</h3>
                <ul id="scriptsList"></ul>
            </div>
            <div id="savedContentDisplay" style="display: none; margin-top: 30px; padding: 20px; background: #f0f4f7; border-radius: 10px;">
                <h3 id="savedContentTitle"></h3>
                <pre id="savedContentText"></pre>
                <button id="closeContentDisplay" class="save-button" data-i18n="close_button">住专</button>
            </div>
        </div>
    </div>

    <script>
        const translations = {
            he: {
                app_title: "   - 转住专  砖",
                language_selector_label: "砖驻:",
                main_title: "锔   砖 专 拽拽住",
                diary_label: " 拽专 ? 专砖  转 砖转/转:",
                diary_placeholder: ":   砖  转 砖注专 转,  驻砖转 专 注 砖砖 注 转 转...",
                genre_label: "专 '专 转住专",
                genre_comedy: "拽",
                genre_drama: "专",
                genre_fantasy: "驻",
                genre_scifi: "注 ",
                genre_adventure: "专驻转拽转",
                genre_action: "驻注",
                genre_slice_of_life: "驻专住转  (驻专)",
                generate_script_button: "驻 住驻专 拽拽住!",
                save_diary_button: "砖专 ",
                save_script_button: "砖专 转住专",
                show_saved_button: "爪 砖专",
                close_button: "住专",
                script_output_title: "转住专 砖  砖:",
                script_placeholder: "转住专 驻注  专 爪专转.",
                loading_message_script: "驻 转  转住专 拽拽住... 拽砖 转",
                saving_diary_message: "砖专 转 ...",
                saving_script_message: "砖专 转 转住专...",
                success_diary_saved: " 砖专 爪!",
                success_script_saved: "转住专 砖专 爪!",
                error_enter_diary: "  砖  砖.",
                error_select_genre: " 专 '专.",
                error_script_creation_failed: "专注 砖 爪专转 转住专 .",
                error_unknown_server: "砖  注 砖专转. 住 砖 专 转专.",
                error_connection_server: "砖转 转拽砖专转 注 砖专转.  拽 转 专 专 砖 住 砖.",
                error_saving_diary: "专注 砖 砖专转 .",
                error_saving_script: "专注 砖 砖专转 转住专.",
                saved_files_title: " 转住专 砖专:",
                saved_diaries_list_title: ":",
                saved_scripts_list_title: "转住专:",
                view_button: "爪",
                error_fetching_saved_files: "专注 砖 专 拽爪 砖专.",
                error_fetching_file_content: "专注 砖 专 转 拽抓.",
                loading_message_fetching_diaries: "注  砖专...",
                loading_message_fetching_scripts: "注 转住专 砖专...",
                loading_message_fetching_content: "注 转 拽抓...",
                no_diaries_saved: "  砖专.",
                no_scripts_saved: " 转住专 砖专.",
                word_count: "{} " // 住专 住住 砖砖  住驻专
            },
            en: {
                app_title: "My Life Diary  - Script from My Day",
                language_selector_label: "Language:",
                main_title: "锔 My Life Diary in Comic Form",
                diary_label: "What happened today? Write your thoughts/experiences here:",
                diary_placeholder: "Example: Today my dog ate my homework, then I met a three-eyed alien at the grocery store...",
                genre_label: "Choose a Genre for the Script",
                genre_comedy: "Comedy",
                genre_drama: "Drama",
                genre_fantasy: "Fantasy",
                genre_scifi: "Science Fiction",
                genre_adventure: "Adventure",
                genre_action: "Action",
                genre_slice_of_life: "Slice of Life",
                generate_script_button: "Turn into a Comic Story!",
                save_diary_button: "Save Diary",
                save_script_button: "Save Script",
                show_saved_button: "Show Saved",
                close_button: "Close",
                script_output_title: "Today's Script:",
                script_placeholder: "The script will appear here after it's generated.",
                loading_message_script: "Turning your diary into a comic script... Please wait",
                saving_diary_message: "Saving diary entry...",
                saving_script_message: "Saving script...",
                success_diary_saved: "Diary entry saved successfully!",
                success_script_saved: "Script saved successfully!",
                error_enter_diary: "Please enter something from your diary.",
                error_select_genre: "Please select a genre.",
                error_script_creation_failed: "An error occurred while creating the script from your diary.",
                error_unknown_server: "Unknown server error. Please try again later.",
                error_connection_server: "Communication error with the server. Please check your internet connection and try again.",
                error_saving_diary: "An error occurred while saving the diary entry.",
                error_saving_script: "An error occurred while saving the script.",
                saved_files_title: "Saved Diaries and Scripts:",
                saved_diaries_list_title: "Diaries:",
                saved_scripts_list_title: "Scripts:",
                view_button: "View",
                error_fetching_saved_files: "An error occurred fetching saved files.",
                error_fetching_file_content: "An error occurred fetching file content.",
                loading_message_fetching_diaries: "Loading saved diaries...",
                loading_message_fetching_scripts: "Loading saved scripts...",
                loading_message_fetching_content: "Loading file content...",
                no_diaries_saved: "No diaries saved.",
                no_scripts_saved: "No scripts saved.",
                word_count: "{} words"
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const languageSelect = document.getElementById("languageSelect");
            const diaryEntryInput = document.getElementById("diaryEntry");
            const genreSelect = document.getElementById("genre");
            const generateButton = document.getElementById("generateButton");
            const saveDiaryButton = document.getElementById("saveDiaryButton");
            const saveScriptButton = document.getElementById("saveScriptButton");
            const scriptOutput = document.getElementById("scriptOutput");
            const loadingMessage = document.getElementById("loadingMessage");
            const errorMessage = document.getElementById("errorMessage");
            const successMessage = document.getElementById("successMessage");
            const scriptOutputContainer = document.getElementById("resultContainer");

            const showSavedButton = document.getElementById("showSavedButton");
            const savedFilesContainer = document.getElementById("savedFilesContainer");
            const closeSavedFilesButton = document.getElementById("closeSavedFiles");
            const diariesList = document.getElementById("diariesList");
            const scriptsList = document.getElementById("scriptsList");
            const savedContentDisplay = document.getElementById("savedContentDisplay");
            const savedContentTitle = document.getElementById("savedContentTitle");
            const savedContentText = document.getElementById("savedContentText");
            const closeContentDisplayButton = document.getElementById("closeContentDisplay");
            
            const diaryWordCount = document.getElementById("diaryWordCount");
            const scriptWordCount = document.getElementById("scriptWordCount");


            const BASE_API_URL = window.location.origin;
            const API_GENERATE_SCRIPT_URL = `${BASE_API_URL}/api/generateScript`;
            const API_SAVE_DIARY_URL = `${BASE_API_URL}/api/saveDiaryEntry`;
            const API_SAVE_SCRIPT_URL = `${BASE_API_URL}/api/saveScript`;

            let currentLang = localStorage.getItem('appLanguage') || 'he';
            let currentDiaryEntry = "";
            let currentScript = "";

            function setLanguage(lang) {
                currentLang = lang;
                localStorage.setItem('appLanguage', lang);
                applyTranslations();
                document.documentElement.lang = lang;
                languageSelect.value = lang;
            }

            function applyTranslations() {
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (translations[currentLang] && translations[currentLang][key]) {
                        element.textContent = translations[currentLang][key];
                    }
                });

                document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-i18n-placeholder');
                    if (translations[currentLang] && translations[currentLang][key]) {
                        element.placeholder = translations[currentLang][key];
                    }
                });

                document.querySelectorAll('#genre option').forEach(option => {
                    const originalValue = option.value;
                    const key = option.getAttribute('data-i18n');
                    if (translations[currentLang] && translations[currentLang][key]) {
                        option.textContent = translations[currentLang][key];
                    } else if (originalValue === "") {
                        option.textContent = translations[currentLang].genre_label.replace("专 '专 转住专", "-- 专 '专 --");
                    }
                    option.value = originalValue;
                });

                const initialScriptPlaceholderHebrew = "转住专 驻注  专 爪专转.";
                const initialScriptPlaceholderEnglish = "The script will appear here after generation.";
                if (scriptOutput.value.trim() === initialScriptPlaceholderHebrew || // 砖转砖 -.value
                    scriptOutput.value.trim() === initialScriptPlaceholderEnglish || // 砖转砖 -.value
                    scriptOutput.value.trim() === "") { // 砖转砖 -.value
                    scriptOutput.value = translations[currentLang].script_placeholder; // 砖转砖 -.value
                }
                // 注 转   注 砖驻 
                updateWordCount(diaryEntryInput, diaryWordCount);
                updateWordCount(scriptOutput, scriptWordCount);
            }

            setLanguage(currentLang);
            updateWordCount(diaryEntryInput, diaryWordCount);
            updateWordCount(scriptOutput, scriptWordCount); // 爪 0  转   转

            languageSelect.addEventListener('change', (event) => {
                setLanguage(event.target.value);
            });

            function clearStatusMessages() {
                loadingMessage.style.display = "none";
                errorMessage.style.display = "none";
                successMessage.style.display = "none";
                errorMessage.textContent = "";
                successMessage.textContent = "";
            }

            function showLoadingMessage(messageKey) {
                loadingMessage.textContent = translations[currentLang][messageKey];
                loadingMessage.style.display = "block";
            }

            function showErrorMessage(messageKey, fallback = '') {
                errorMessage.textContent = translations[currentLang][messageKey] || fallback;
                errorMessage.style.display = "block";
            }

            function showSuccessMessage(messageKey) {
                successMessage.textContent = translations[currentLang][messageKey];
                successMessage.style.display = "block";
                setTimeout(() => {
                    successMessage.style.display = "none";
                }, 3000);
            }

            function disableSaveButtons() {
                saveDiaryButton.disabled = true;
                saveScriptButton.disabled = true;
            }

            function enableSaveButtons() {
                saveDiaryButton.disabled = !currentDiaryEntry;
                saveScriptButton.disabled = !currentScript;
            }

            function updateWordCount(textareaElement, countElement) {
                const text = textareaElement.value.trim();
                const words = text ? text.split(/\s+/).filter(word => word.length > 0).length : 0;
                countElement.textContent = translations[currentLang].word_count.replace("{}", words);
            }

            disableSaveButtons();

            // 驻拽爪 转 爪转 拽爪
            async function fetchAndDisplayFiles(type, listElement) {
                clearStatusMessages();
                listElement.innerHTML = ''; // 拽 专砖 拽转
                showLoadingMessage(`loading_message_fetching_${type}`); 

                try {
                    const response = await fetch(`${BASE_API_URL}/api/saved${type.charAt(0).toUpperCase() + type.slice(1)}`);
                    const files = await response.json();

                    if (response.ok) {
                        if (files.length === 0) {
                            listElement.innerHTML = `<p data-i18n="no_${type}_saved"> ${type === 'diaries' ? '' : '转住专'} 砖专.</p>`;
                            applyTranslations(); 
                        } else {
                            files.forEach(file => {
                                const li = document.createElement('li');
                                const fileNameSpan = document.createElement('span');
                                // Remove the timestamp for display, keep only relevant name part
                                const displayFileName = file.name.replace(/(diary_|script_)/, '').replace(/\.txt$/, '').split('T')[0]; // Adjust as needed
                                fileNameSpan.textContent = displayFileName;
                                
                                const viewButton = document.createElement('button');
                                viewButton.textContent = translations[currentLang].view_button;
                                viewButton.classList.add('save-button');
                                viewButton.onclick = () => fetchFileContent(file.path, file.name);

                                li.appendChild(fileNameSpan);
                                li.appendChild(viewButton);
                                listElement.appendChild(li);
                            });
                            applyTranslations(); 
                        }
                    } else {
                        showErrorMessage('error_fetching_saved_files', files.error);
                    }
                } catch (error) {
                    console.error(`Error fetching saved ${type}:`, error);
                    showErrorMessage('error_connection_server');
                } finally {
                    loadingMessage.style.display = "none";
                }
            }

            // 驻拽爪 爪转 转 拽抓
            async function fetchFileContent(filePath, fileName) {
                clearStatusMessages();
                showLoadingMessage('loading_message_fetching_content');
                savedContentDisplay.style.display = 'none';

                try {
                    const response = await fetch(filePath);
                    const content = await response.text();

                    if (response.ok) {
                        savedContentTitle.textContent = fileName;
                        savedContentText.textContent = content;
                        savedContentDisplay.style.display = 'block';
                        savedFilesContainer.scrollTop = savedContentDisplay.offsetTop; 
                    } else {
                        showErrorMessage('error_fetching_file_content', content);
                    }
                } catch (error) {
                    console.error("Error fetching file content:", error);
                    showErrorMessage('error_connection_server');
                } finally {
                    loadingMessage.style.display = "none";
                }
            }


            generateButton.addEventListener("click", async () => {
                clearStatusMessages();
                scriptOutput.value = translations[currentLang].script_placeholder; // 砖 -.value
                updateWordCount(scriptOutput, scriptWordCount); // 注  
                scriptOutputContainer.style.display = 'none';
                disableSaveButtons();

                const diaryEntry = diaryEntryInput.value.trim();
                const genre = genreSelect.value;

                if (!diaryEntry) {
                    showErrorMessage('error_enter_diary');
                    return;
                }
                if (!genre) {
                    showErrorMessage('error_select_genre');
                    return;
                }

                currentDiaryEntry = diaryEntry;
                currentScript = ""; // 驻住 转住专  驻 爪专 砖

                generateButton.disabled = true;
                showLoadingMessage('loading_message_script');

                try {
                    const response = await fetch(API_GENERATE_SCRIPT_URL, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ diaryEntry, genre, lang: currentLang }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        scriptOutput.value = data.script; // 砖 -.value
                        currentScript = data.script;
                        scriptOutputContainer.style.display = 'block';
                        enableSaveButtons();
                        updateWordCount(scriptOutput, scriptWordCount); // 注  
                    } else {
                        const errorMsg = data.error || translations[currentLang].error_unknown_server;
                        showErrorMessage('error_script_creation_failed', errorMsg);
                        scriptOutput.value = translations[currentLang].error_script_creation_failed; // 砖 -.value
                        currentScript = ""; //  砖 爪专,  转住专 砖专
                        scriptOutputContainer.style.display = 'block';
                        updateWordCount(scriptOutput, scriptWordCount); // 注    砖
                    }

                } catch (error) {
                    console.error("砖 砖转 拽砖  拽转 转砖:", error);
                    showErrorMessage('error_connection_server');
                    scriptOutput.value = translations[currentLang].error_script_creation_failed; // 砖 -.value
                    scriptOutputContainer.style.display = 'block';
                    updateWordCount(scriptOutput, scriptWordCount); // 注    砖
                } finally {
                    generateButton.disabled = false;
                    loadingMessage.style.display = "none";
                }
            });

            saveDiaryButton.addEventListener("click", async () => {
                clearStatusMessages();
                if (!currentDiaryEntry) {
                    showErrorMessage('error_enter_diary');
                    return;
                }
                saveDiaryButton.disabled = true;
                showLoadingMessage('saving_diary_message');

                try {
                    const response = await fetch(API_SAVE_DIARY_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ diaryEntry: currentDiaryEntry, lang: currentLang }),
                    });

                    if (response.ok) {
                        showSuccessMessage('success_diary_saved');
                    } else {
                        const errorData = await response.json();
                        showErrorMessage('error_saving_diary', errorData.error);
                    }
                } catch (error) {
                    console.error("砖 砖专转 :", error);
                    showErrorMessage('error_connection_server');
                } finally {
                    saveDiaryButton.disabled = false;
                    loadingMessage.style.display = "none";
                }
            });

            saveScriptButton.addEventListener("click", async () => {
                clearStatusMessages();
                if (!currentScript) {
                    showErrorMessage('error_script_creation_failed');
                    return;
                }
                saveScriptButton.disabled = true;
                showLoadingMessage('saving_script_message');

                try {
                    const response = await fetch(API_SAVE_SCRIPT_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ script: currentScript, lang: currentLang }),
                    });

                    if (response.ok) {
                        showSuccessMessage('success_script_saved');
                    } else {
                        const errorData = await response.json();
                        showErrorMessage('error_saving_script', errorData.error);
                    }
                } catch (error) {
                    console.error("砖 砖专转 转住专:", error);
                    showErrorMessage('error_connection_server');
                } finally {
                    saveScriptButton.disabled = false;
                    loadingMessage.style.display = "none";
                }
            });

            diaryEntryInput.addEventListener('input', () => {
                currentDiaryEntry = diaryEntryInput.value.trim(); // 注 转 currentDiaryEntry
                saveDiaryButton.disabled = currentDiaryEntry === "";
                updateWordCount(diaryEntryInput, diaryWordCount);
            });

            scriptOutput.addEventListener('input', () => {
                currentScript = scriptOutput.value.trim(); // 注 转 currentScript 注 转 注专
                saveScriptButton.disabled = currentScript === "";
                updateWordCount(scriptOutput, scriptWordCount);
            });

            // 专注 爪 注 驻转专 "爪 砖专"
            showSavedButton.addEventListener('click', async () => {
                clearStatusMessages();
                document.querySelector('.input-section').style.display = 'none'; // 住转专 转 专 拽
                scriptOutputContainer.style.display = 'none'; // 住转专 转爪转
                savedFilesContainer.style.display = 'block'; // 爪 转 专 拽爪 砖专
                savedContentDisplay.style.display = 'none'; //  砖转爪转 转 住转专转

                await fetchAndDisplayFiles('diaries', diariesList);
                await fetchAndDisplayFiles('scripts', scriptsList);
            });

            // 专注 爪 注 驻转专 "住专" 专 拽爪 砖专
            closeSavedFilesButton.addEventListener('click', () => {
                clearStatusMessages();
                savedFilesContainer.style.display = 'none';
                savedContentDisplay.style.display = 'none'; 
                document.querySelector('.input-section').style.display = 'block'; // 爪 专 转 专 拽
                // 驻住   砖 转住专 砖砖拽 专砖 专
                scriptOutput.value = translations[currentLang].script_placeholder;
                currentScript = "";
                updateWordCount(scriptOutput, scriptWordCount);
            });

            // 专注 爪 注 驻转专 "住专" 转爪转 转 拽抓
            closeContentDisplayButton.addEventListener('click', () => {
                clearStatusMessages();
                savedContentDisplay.style.display = 'none';
            });
        });
    </script>
</body>
</html>